<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å‰‰å†°é»é¤</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fffde7; }
    .section { margin-bottom: 20px; }
    button { padding: 10px 20px; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>å‰‰å†°é»é¤</h1>
  <div id="selector" class="section"></div>
  <button id="add-bowl">â• åŠ å…¥é€™ç¢—</button>
  <div id="order" class="section"></div>
  <button id="submit">âœ… é€å‡ºè¨‚å–®</button>

  <script>
    const baseToppings = ["ç´…è±†", "ç¶ è±†", "ç²‰åœ“", "èŠ±ç”Ÿ"];
    const extraToppings = ["èŠ‹åœ“", "åœ°ç“œåœ“", "ä»™è‰", "ç…‰ä¹³"];
    let displayName = "";
    let iceBowls = [];
    let currentBowl = { base: {}, extra: {} };

    function renderSelector() {
      const div = document.getElementById("selector");
      div.innerHTML = `<h3>é¸æ“‡åŸºæœ¬é…æ–™ï¼ˆå‰›å¥½4ä»½ï¼‰</h3>`;
      baseToppings.forEach(t => {
        div.innerHTML += `${t} <button onclick="update('base','${t}',-1)">-</button> ${currentBowl.base[t] || 0} <button onclick="update('base','${t}',1)">+</button><br>`;
      });
      div.innerHTML += `<h3>é¡å¤–é…æ–™ï¼ˆæ¯ä»½+5å…ƒï¼‰</h3>`;
      extraToppings.forEach(t => {
        div.innerHTML += `${t} <button onclick="update('extra','${t}',-1)">-</button> ${currentBowl.extra[t] || 0} <button onclick="update('extra','${t}',1)">+</button><br>`;
      });
    }

    function update(type, name, delta) {
      const obj = type === "base" ? currentBowl.base : currentBowl.extra;
      const val = (obj[name] || 0) + delta;
      if (val < 0) return;
      if (type === "base") {
        const total = Object.values(currentBowl.base).reduce((a,b)=>a+b,0);
        if (delta > 0 && total >= 4) return;
      }
      obj[name] = val;
      renderSelector();
    }

    function renderOrder() {
      const div = document.getElementById("order");
      div.innerHTML = "";
      iceBowls.forEach((bowl, i) => {
        const base = Object.entries(bowl.base).map(([k,v]) => `${k}Ã—${v}`).join("ã€");
        const extra = Object.entries(bowl.extra).map(([k,v]) => `${k}Ã—${v}`).join("ã€") || "ç„¡";
        div.innerHTML += `<p>ğŸ§ ç¬¬${i+1}ç¢—<br>åŸºæœ¬ï¼š${base}<br>é¡å¤–ï¼š${extra}</p>`;
      });
    }

    document.getElementById("add-bowl").onclick = () => {
      const total = Object.values(currentBowl.base).reduce((a,b)=>a+b,0);
      if (total !== 4) return alert("åŸºæœ¬é…æ–™éœ€å‰›å¥½ 4 ä»½ï¼");
      iceBowls.push(JSON.parse(JSON.stringify(currentBowl)));
      currentBowl = { base: {}, extra: {} };
      renderSelector();
      renderOrder();
    };

    document.getElementById("submit").onclick = () => {
      if (!iceBowls.length) return alert("è«‹è‡³å°‘åŠ å…¥ä¸€ç¢—å‰‰å†°ï¼");
      fetch("https://script.google.com/macros/s/AKfycbxVABFDadhqB8EYObIFQ1XaqQ3pfobenUmZ6DWngYf46L9X4QSxMQqqBUMcn_ZQ0iHr/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ displayName, items: iceBowls })
      }).then(res => res.text())
        .then(txt => {
          alert("è¨‚å–®å·²é€å‡ºï¼");
          location.reload();
        }).catch(err => {
          alert("é€å‡ºå¤±æ•—ï¼");
          console.error(err);
        });
    };

    async function init() {
      await liff.init({ liffId: "ä½ çš„ LIFF ID" });
      if (!liff.isLoggedIn()) liff.login();
      const profile = await liff.getProfile();
      displayName = profile.displayName;
    }

    init();
    renderSelector();
  </script>
</body>
</html>
