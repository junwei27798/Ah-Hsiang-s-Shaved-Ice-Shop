<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>剉冰訂單測試 (加減按鈕 + iframe)</title>
  <style>
    .topping {
      margin-bottom: 10px;
    }

    .qty-controls {
      display: inline-flex;
      align-items: center;
    }

    .qty-controls button {
      width: 28px;
      height: 28px;
      font-size: 18px;
      line-height: 18px;
      cursor: pointer;
    }

    .qty-controls input {
      width: 40px;
      text-align: center;
      margin: 0 5px;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <h1>剉冰訂單測試 (iframe 送出)</h1>

  <form method="POST"
    action="https://script.google.com/macros/s/AKfycbybspWTA86_Xdd0goi_vDmR4EdI84PtvMHHS09XifBHw-8zRvBTC_B4kLD9F1GNocu6/exec"
    target="hidden_iframe" id="testForm">
    
    <label>
      訂購人名稱：
      <input type="text" name="displayName" value="測試用戶" required />
    </label>

    <h3>基本配料（至少選 4 份）</h3>
    <div class="topping">
      紅豆：
      <div class="qty-controls">
        <button type="button" data-target="redBean">−</button>
        <input type="number" id="redBean" min="0" value="0" />
        <button type="button" data-target="redBean">＋</button>
      </div>
    </div>
    <div class="topping">
      綠豆：
      <div class="qty-controls">
        <button type="button" data-target="greenBean">−</button>
        <input type="number" id="greenBean" min="0" value="0" />
        <button type="button" data-target="greenBean">＋</button>
      </div>
    </div>
    <div class="topping">
      仙草：
      <div class="qty-controls">
        <button type="button" data-target="grassJelly">−</button>
        <input type="number" id="grassJelly" min="0" value="0" />
        <button type="button" data-target="grassJelly">＋</button>
      </div>
    </div>
    <div class="topping">
      芋圓：
      <div class="qty-controls">
        <button type="button" data-target="taroBall">−</button>
        <input type="number" id="taroBall" min="0" value="0" />
        <button type="button" data-target="taroBall">＋</button>
      </div>
    </div>

    <h3>額外配料（可選）</h3>
    <div class="topping">
      煉乳：
      <div class="qty-controls">
        <button type="button" data-target="condensedMilk">−</button>
        <input type="number" id="condensedMilk" min="0" value="0" />
        <button type="button" data-target="condensedMilk">＋</button>
      </div>
    </div>
    <div class="topping">
      巧克力醬：
      <div class="qty-controls">
        <button type="button" data-target="chocolateSauce">−</button>
        <input type="number" id="chocolateSauce" min="0" value="0" />
        <button type="button" data-target="chocolateSauce">＋</button>
      </div>
    </div>

    <!-- 隱藏欄位：items -->
    <input type="hidden" name="items" id="itemsInput" />

    <br />
    <button type="submit">送出測試訂單</button>
  </form>

  <!-- 隱藏 iframe -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
    const baseIds = ["redBean", "greenBean", "grassJelly", "taroBall"];
    const extraIds = ["condensedMilk", "chocolateSauce"];
    const idToName = {
      redBean: "紅豆",
      greenBean: "綠豆",
      grassJelly: "仙草",
      taroBall: "芋圓",
      condensedMilk: "煉乳",
      chocolateSauce: "巧克力醬"
    };

    // 加減按鈕
    document.querySelectorAll("button[data-target]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-target");
        const input = document.getElementById(id);
        let val = parseInt(input.value) || 0;
        if (btn.textContent === "＋") {
          input.value = val + 1;
        } else if (btn.textContent === "−") {
          if (val > 0) input.value = val - 1;
        }
      });
    });

    // 表單送出前，組成 JSON
    document.getElementById("testForm").addEventListener("submit", (e) => {
      const baseToppings = {};
      let baseCount = 0;
      baseIds.forEach(id => {
        const qty = parseInt(document.getElementById(id).value) || 0;
        if (qty > 0) {
          baseToppings[idToName[id]] = qty;
          baseCount += qty;
        }
      });

      if (baseCount < 4) {
        alert("基本配料至少選 4 份！");
        e.preventDefault();
        return;
      }

      const extraToppings = {};
      extraIds.forEach(id => {
        const qty = parseInt(document.getElementById(id).value) || 0;
        if (qty > 0) {
          extraToppings[idToName[id]] = qty;
        }
      });

      const bowl = { baseToppings, extraToppings };
      const items = [bowl];

      document.getElementById("itemsInput").value = JSON.stringify(items);
    });
  </script>
</body>
</html>
