<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‰‰å†°é»é¤</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
  * {
    box-sizing: border-box;
  }

  body {
    font-family: "Helvetica Neue", "Segoe UI", "Noto Sans TC", sans-serif;
    padding: 20px;
    margin: 0;
    background-color: #f7f9fb;
    color: #333;
  }

  h1 {
    text-align: center;
    margin-bottom: 24px;
    font-size: 28px;
    color: #2c3e50;
  }

  .section {
    background: #fff;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
    border: 1px solid #e0e0e0;
  }

  h3 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 20px;
    color: #34495e;
  }

  p {
    margin: 12px 0 8px;
    font-weight: bold;
  }

  button {
    font-size: 16px;
    margin: 2px;
    padding: 5px 10px;
    border: 1px solid #3498db;
    background-color: #3498db;
    color: white;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s;
  }

  button:hover {
    background-color: #2980b9;
  }

  .delete-btn {
    background-color: #e74c3c;
    border-color: #e74c3c;
  }

  .delete-btn:hover {
    background-color: #c0392b;
  }

  .action-btn {
    width: 100%;
    padding: 12px;
    font-size: 18px;
    margin-top: 16px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
  }

  .add-bowl-btn {
    background-color: #1abc9c;
    color: white;
  }

  .add-bowl-btn:hover {
    background-color: #16a085;
  }

  .submit-btn {
    background-color: #2ecc71;
    color: white;
  }

  .submit-btn:hover {
    background-color: #27ae60;
  }

  .price-tag {
    font-weight: bold;
    font-size: 16px;
    color: #2c3e50;
    margin-top: 12px;
  }

  .ice-bowl {
    margin-bottom: 20px;
    border-top: 1px solid #ccc;
    padding-top: 12px;
  }
</style>


</head>

<body>
  <h1>å‰‰å†°é»é¤</h1>

  <div class="section" id="topping-selector"></div>

  <button class="action-btn add-bowl-btn" id="add-bowl-btn">âœ… åŠ å…¥é€™ç¢—å‰‰å†°</button>

  <div class="section" id="bowl-list"></div>

  <button class="action-btn submit-btn" id="submit-order">é€å‡ºè¨‚å–®</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCCa8GMfHlu40X4xwLeRFiguciptNW10Xg",
      authDomain: "ah-hsiang-s-shaved-ice-shop.firebaseapp.com",
      databaseURL: "https://ah-hsiang-s-shaved-ice-shop-default-rtdb.firebaseio.com",
      projectId: "ah-hsiang-s-shaved-ice-shop",
      storageBucket: "ah-hsiang-s-shaved-ice-shop.firebasestorage.app",
      messagingSenderId: "525201397285",
      appId: "1:525201397285:web:7aa0a8c08faabcba1591cc",
      measurementId: "G-7C7J14C0S6"
    };
    firebase.initializeApp(firebaseConfig);

    const baseToppings = ["ç´…è±†", "ç¶ è±†", "ç²‰åœ“", "èŠ±ç”Ÿ"];
    const extraToppings = ["èŠ‹åœ“", "åœ°ç“œåœ“", "ä»™è‰", "ç…‰ä¹³"];
    let userId = "";
    let displayName = "";

    let currentSelection = {
      baseToppings: {},
      extraToppings: {}
    };
    let iceBowls = [];

    function updateTopping(type, name, delta) {
      const toppings = type === "base" ? currentSelection.baseToppings : currentSelection.extraToppings;
      const value = toppings[name] || 0;
      const newVal = Math.max(0, value + delta);

      if (type === "base") {
        const totalBase = Object.values(currentSelection.baseToppings).reduce((a, b) => a + b, 0);
        if (delta > 0 && totalBase >= 4) return; // é™åˆ¶åŸºæœ¬é…æ–™æœ€å¤š4
      }

      toppings[name] = newVal;
      renderSelector();
    }

    function calculatePrice(bowl) {
      const basePrice = 60;
      const extraCount = Object.values(bowl.extraToppings).reduce((a, b) => a + b, 0);
      return basePrice + extraCount * 5;
    }

    function renderSelector() {
      const div = document.getElementById("topping-selector");
      div.innerHTML = `
        <h3>è«‹é¸æ“‡é…æ–™</h3>
        <p><strong>åŸºæœ¬é…æ–™ï¼ˆå‰›å¥½4ä»½ï¼‰</strong></p>
        ${baseToppings.map(t => `
          ${t} <button onclick="updateTopping('base', '${t}', -1)">-</button>
          ${currentSelection.baseToppings[t] || 0}
          <button onclick="updateTopping('base', '${t}', 1)">+</button><br>
        `).join("")}
        <p><strong>é¡å¤–é…æ–™ï¼ˆæ¯ä»½+5å…ƒï¼‰</strong></p>
        ${extraToppings.map(t => `
          ${t} <button onclick="updateTopping('extra', '${t}', -1)">-</button>
          ${currentSelection.extraToppings[t] || 0}
          <button onclick="updateTopping('extra', '${t}', 1)">+</button><br>
        `).join("")}
      `;
    }

    function renderBowlList() {
      const listDiv = document.getElementById("bowl-list");
      listDiv.innerHTML = "";

      let total = 0;

      iceBowls.forEach((bowl, index) => {
        const price = calculatePrice(bowl);
        total += price;
        const el = document.createElement("div");
        el.className = "ice-bowl";
        el.innerHTML = `
          <h3>å‰‰å†° ${index + 1}</h3>
          <p>åŸºæœ¬é…æ–™: ${Object.entries(bowl.baseToppings).map(([k, v]) => `${k}Ã—${v}`).join(", ")}</p>
          <p>é¡å¤–é…æ–™: ${Object.entries(bowl.extraToppings).map(([k, v]) => `${k}Ã—${v}`).join(", ") || "ç„¡"}</p>
          <p class="price-tag">å°è¨ˆï¼š$${price}</p>
          <button class="delete-btn" onclick="removeBowl(${index})">åˆªé™¤é€™ç¢—</button>
        `;
        listDiv.appendChild(el);
      });

      const totalEl = document.createElement("p");
      totalEl.className = "price-tag";
      totalEl.innerText = `ç¸½é‡‘é¡ï¼š$${total}`;
      listDiv.appendChild(totalEl);
    }

    function removeBowl(index) {
      iceBowls.splice(index, 1);
      renderBowlList();
    }

    document.getElementById("add-bowl-btn").onclick = () => {
      const totalBase = Object.values(currentSelection.baseToppings).reduce((a, b) => a + b, 0);
      if (totalBase !== 4) return alert("åŸºæœ¬é…æ–™å¿…é ˆå‰›å¥½é¸4ä»½ï¼");

      iceBowls.push(JSON.parse(JSON.stringify(currentSelection))); // æ·±æ‹·è²
      currentSelection = { baseToppings: {}, extraToppings: {} };
      renderSelector();
      renderBowlList();
    };

    document.getElementById("submit-order").onclick = () => {
      if (!iceBowls.length) return alert("è«‹è‡³å°‘åŠ å…¥ä¸€ç¢—å‰‰å†°");

      const order = {
        items: iceBowls,
        displayName,
        status: "confirmed",
        createdAt: Date.now()
      };

      firebase.database().ref("orders/" + userId).set(order).then(() => {
  // è¨ˆç®—ç¸½é‡‘é¡
  const totalPrice = iceBowls.reduce((sum, bowl) => sum + calculatePrice(bowl), 0);

  // æ•´ç†è¨Šæ¯å…§å®¹
  const msgLines = iceBowls.map((bowl, i) => {
    const base = Object.entries(bowl.baseToppings).map(([k, v]) => `${k}Ã—${v}`).join("ã€");
    const extra = Object.entries(bowl.extraToppings).map(([k, v]) => `${k}Ã—${v}`).join("ã€") || "ç„¡";
    const subTotal = calculatePrice(bowl);
    return `ç¬¬ ${i + 1} ç¢—\nåŸºæœ¬ï¼š${base}\né¡å¤–ï¼š${extra}\nå°è¨ˆï¼š$${subTotal}`;
  }).join("\n\n");

  const notifyMessage = `ğŸ§ æœ‰æ–°è¨‚å–®ï¼\nğŸ‘¤ é¡§å®¢ï¼š${displayName}\n\n${msgLines}\n\nç¸½é‡‘é¡ï¼š$${totalPrice}`;

  // å‚³é€ LINE æ¨æ’­é€šçŸ¥
  fetch("https://script.google.com/macros/s/AKfycbyGeH_4a86oYcBa4SLbXLY6GJIohLcsSIG5xlzmB791YcC-lKUaD1XC2PxJVS_7PpNI/exec", {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      userId: "U881e6f581fe3d937d6994ae908889712",  // ä½ çš„ LINE userId
      message: notifyMessage
    })
  });

  // å°å‘ç¢ºèªé é¢
  location.href = "confirm.html";
});

    };

    async function initLIFF() {
      await liff.init({ liffId: "2007677925-l15WX11o" });
      if (!liff.isLoggedIn()) {
        liff.login();
      } else {
        const profile = await liff.getProfile();
        userId = profile.userId;
        displayName = profile.displayName;

        firebase.database().ref("orders/" + userId).once("value").then(snapshot => {
          const order = snapshot.val();
          if (order && (order.status === "pending" || order.status === "confirmed")) {
            location.href = "confirm.html";
          }
        });
      }
    }

    initLIFF();
    renderSelector();
  </script>
</body>

</html>
