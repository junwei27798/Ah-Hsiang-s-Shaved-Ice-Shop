<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>剉冰訂購</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>選擇剉冰配料</h1>

  <div>
    <h2>基本配料（最多4份）</h2>
    <div id="basic-toppings">
      <button onclick="addTopping('紅豆', 'basic')">紅豆</button>
      <button onclick="addTopping('綠豆', 'basic')">綠豆</button>
      <button onclick="addTopping('粉圓', 'basic')">粉圓</button>
      <button onclick="addTopping('芋圓', 'basic')">芋圓</button>
    </div>
    <p>已選 <span id="basic-count">0</span>/4</p>
  </div>

  <div>
    <h2>額外配料（不限）</h2>
    <div id="extra-toppings">
      <button onclick="addTopping('紅豆', 'extra')">紅豆</button>
      <button onclick="addTopping('綠豆', 'extra')">綠豆</button>
      <button onclick="addTopping('粉圓', 'extra')">粉圓</button>
      <button onclick="addTopping('芋圓', 'extra')">芋圓</button>
    </div>
  </div>

  <h2>目前這碗剉冰</h2>
  <ul id="current-bowl"></ul>
  <button onclick="addBowl()">加入一碗剉冰</button>

  <h2>已加入的碗</h2>
  <ul id="bowls-list"></ul>

  <button onclick="submitOrder()">送出訂單</button>

  <!-- Firebase + 全部邏輯 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCa8GMfHlu40X4xwLeRFiguciptNW10Xg",
      authDomain: "ah-hsiang-s-shaved-ice-shop.firebaseapp.com",
      projectId: "ah-hsiang-s-shaved-ice-shop",
      storageBucket: "ah-hsiang-s-shaved-ice-shop.appspot.com",
      messagingSenderId: "525201397285",
      appId: "1:525201397285:web:7aa0a8c08faabcba1591cc",
      measurementId: "G-7C7J14C0S6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);
    const orderRef = doc(db, "orders", "latest_order");

    // 點餐邏輯
    let currentBowl = { basic: [], extra: [] };
    let currentBasicCount = 0;
    let allBowls = [];

    window.addTopping = function (item, type) {
      if (type === "basic") {
        if (currentBasicCount >= 4) {
          alert("基本配料最多 4 份！");
          return;
        }
        currentBowl.basic.push(item);
        currentBasicCount++;
        document.getElementById("basic-count").textContent = currentBasicCount;
      } else {
        currentBowl.extra.push(item);
      }
      updateCurrentBowlDisplay();
    };

    function updateCurrentBowlDisplay() {
      const list = document.getElementById("current-bowl");
      list.innerHTML = "";
      currentBowl.basic.forEach(t => {
        const li = document.createElement("li");
        li.textContent = "基本：" + t;
        list.appendChild(li);
      });
      currentBowl.extra.forEach(t => {
        const li = document.createElement("li");
        li.textContent = "額外：" + t;
        list.appendChild(li);
      });
    }

    window.addBowl = function () {
      if (currentBowl.basic.length === 0 && currentBowl.extra.length === 0) {
        alert("請先選擇配料");
        return;
      }
      allBowls.push({ ...currentBowl });
      currentBowl = { basic: [], extra: [] };
      currentBasicCount = 0;
      document.getElementById("basic-count").textContent = "0";
      updateCurrentBowlDisplay();
      renderBowls();
    };

    function renderBowls() {
      const list = document.getElementById("bowls-list");
      list.innerHTML = "";
      allBowls.forEach((bowl, index) => {
        const li = document.createElement("li");
        li.textContent = `第 ${index + 1} 碗：基本(${bowl.basic.join(", ")})；額外(${bowl.extra.join(", ")})`;
        list.appendChild(li);
      });
    }

    window.submitOrder = async function () {
      if (allBowls.length === 0) {
        alert("請至少加入一碗剉冰！");
        return;
      }
      await setDoc(orderRef, {
        bowls: allBowls,
        status: "open",
        timestamp: Date.now()
      });
      location.href = "confirm.html";
    };

    // 自動跳轉 confirm.html（若已下單）
    async function checkOrderStatus() {
      const snap = await getDoc(orderRef);
      if (snap.exists() && snap.data().status === "open") {
        location.href = "confirm.html";
      }
    }

    // 初始化 LIFF + 檢查狀態
    window.onload = async () => {
      await liff.init({ liffId: "2007677925-l15WX11o" });
      await checkOrderStatus();
    };
  </script>
</body>
</html>
