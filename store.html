<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>商家訂單管理</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>商家訂單總覽</h1>
  <div id="store-orders">載入中...</div>
  <button id="close-btn">結束訂單</button>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCa8GMfHlu40X4xwLeRFiguciptNW10Xg",
      authDomain: "ah-hsiang-s-shaved-ice-shop.firebaseapp.com",
      projectId: "ah-hsiang-s-shaved-ice-shop",
      storageBucket: "ah-hsiang-s-shaved-ice-shop.appspot.com",
      messagingSenderId: "525201397285",
      appId: "1:525201397285:web:7aa0a8c08faabcba1591cc",
      measurementId: "G-7C7J14C0S6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);
    const orderRef = doc(db, "orders", "latest_order");
    const display = document.getElementById("store-orders");

    function renderOrder(data) {
      const bowls = data.bowls || [];
      if (bowls.length === 0) {
        display.innerHTML = "<p>尚無訂單</p>";
        return;
      }

      let html = "<h3>訂單內容：</h3><ul>";
      bowls.forEach((bowl, index) => {
        html += `<li>第 ${index + 1} 碗 - 基本：${bowl.basic.join(", ")}；額外：${bowl.extra.join(", ")}</li>`;
      });
      html += "</ul>";
      html += `<p>狀態：<strong>${data.status === "closed" ? "已結單" : "進行中"}</strong></p>`;
      display.innerHTML = html;
    }

    onSnapshot(orderRef, (snap) => {
      if (!snap.exists()) {
        display.innerHTML = "<p>尚無訂單</p>";
        return;
      }
      renderOrder(snap.data());
    });

    document.getElementById("close-btn").onclick = async () => {
      await setDoc(orderRef, { status: "closed" }, { merge: true });
      alert("訂單已結束");
    };
  </script>
</body>
</html>
